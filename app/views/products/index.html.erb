<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="display-4 fw-bold">Our Products</h1>
    <div>
      <span class="badge bg-primary fs-5 rounded-pill me-2"><%= @products.count %> Items</span>
      <%= link_to "Add New Product", new_product_path, class: "btn btn-success" %>
    </div>
  </div>

  <!-- Advanced Search and Filter Section -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-white">
      <h5 class="mb-0">
        <i class="bi bi-funnel me-2"></i>Search & Filter
        <% if @active_filters_count.to_i > 0 %>
          <span class="badge bg-primary ms-2"><%= @active_filters_count %> active</span>
        <% end %>
      </h5>
    </div>
    <div class="card-body">
      <%= form_with url: products_path, method: :get, local: true, id: "filter-form" do |f| %>
        <div class="row g-3">
          <!-- Search Input -->
          <div class="col-md-6 col-lg-4">
            <label class="form-label fw-bold">Search</label>
            <%= f.text_field :search,
                value: params[:search],
                class: "form-control",
                placeholder: "Search by name or description..." %>
          </div>

          <!-- Category Filter -->
          <div class="col-md-6 col-lg-2">
            <label class="form-label fw-bold">Category</label>
            <%= f.select :category_id,
                options_from_collection_for_select(@categories || [], :id, :name, params[:category_id]),
                { prompt: "All Categories" },
                class: "form-select", onchange: "this.form.submit()" %>
          </div>

          <!-- Min Price -->
          <div class="col-6 col-md-3 col-lg-1">
            <label class="form-label fw-bold">Min Price</label>
            <%= f.number_field :min_price,
                value: params[:min_price],
                class: "form-control",
                min: 0,
                placeholder: "0" %>
          </div>

          <!-- Max Price -->
          <div class="col-6 col-md-3 col-lg-1">
            <label class="form-label fw-bold">Max Price</label>
            <%= f.number_field :max_price,
                value: params[:max_price],
                class: "form-control",
                min: 0,
                placeholder: "Any" %>
          </div>

          <!-- Stock Status -->
          <div class="col-md-3 col-lg-2">
            <label class="form-label fw-bold">Availability</label>
            <%= f.select :stock_status,
                options_for_select([
                  ["All Items", ""],
                  ["In Stock", "in_stock"],
                  ["Out of Stock", "out_of_stock"]
                ], params[:stock_status]),
                {},
                class: "form-select", onchange: "this.form.submit()" %>
          </div>

          <!-- Sort Options -->
          <div class="col-md-3 col-lg-2">
            <label class="form-label fw-bold">Sort By</label>
            <%= f.select :sort,
                options_for_select([
                  ["Newest First", "newest"],
                  ["Oldest First", "oldest"],
                  ["Price: Low to High", "price_asc"],
                  ["Price: High to Low", "price_desc"],
                  ["Name: A-Z", "name_asc"],
                  ["Name: Z-A", "name_desc"]
                ], params[:sort] || "newest"),
                {},
                class: "form-select", onchange: "this.form.submit()" %>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="d-flex gap-2 flex-wrap">
              <%= f.submit "Apply Filters", class: "btn btn-primary" %>
              <% if @active_filters_count.to_i > 0 %>
                <%= link_to products_path, class: "btn btn-outline-secondary" do %>
                  <i class="bi bi-x-circle me-1"></i>Clear All Filters
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Active Filters Display -->
  <% if @active_filters_count.to_i > 0 %>
    <div class="mb-3">
      <strong>Active Filters:</strong>
      <% if params[:search].present? %>
        <span class="badge bg-secondary me-1">
          Search: "<%= params[:search] %>"
          <%= link_to products_path(request.query_parameters.except(:search)), class: "text-white ms-1" do %>
            <i class="bi bi-x"></i>
          <% end %>
        </span>
      <% end %>
      <% if params[:category_id].present? %>
        <span class="badge bg-info me-1">
          Category: <%= Category.find_by(id: params[:category_id])&.name %>
          <%= link_to products_path(request.query_parameters.except(:category_id)), class: "text-white ms-1" do %>
            <i class="bi bi-x"></i>
          <% end %>
        </span>
      <% end %>
      <% if params[:min_price].present? || params[:max_price].present? %>
        <span class="badge bg-success me-1">
          Price: <%= params[:min_price].presence || "0" %> - <%= params[:max_price].presence || "âˆž" %>
          <%= link_to products_path(request.query_parameters.except(:min_price, :max_price)), class: "text-white ms-1" do %>
            <i class="bi bi-x"></i>
          <% end %>
        </span>
      <% end %>
      <% if params[:stock_status].present? %>
        <span class="badge bg-warning text-dark me-1">
          <%= params[:stock_status] == "in_stock" ? "In Stock" : "Out of Stock" %>
          <%= link_to products_path(request.query_parameters.except(:stock_status)), class: "text-dark ms-1" do %>
            <i class="bi bi-x"></i>
          <% end %>
        </span>
      <% end %>
    </div>
  <% end %>

  <!-- Search Results Message -->
  <div class="alert alert-light border mb-4">
    <strong>Found <%= @products.count %> product(s)</strong>
    <% if @price_stats && @price_stats[:min] && @price_stats[:max] %>
      <span class="text-muted ms-2">
        | Price range: KSh <%= number_with_delimiter(@price_stats[:min].to_i) %> - <%= number_with_delimiter(@price_stats[:max].to_i) %>
      </span>
    <% end %>
  </div>

  <% if @products.any? %>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <% @products.each do |product| %>
        <div class="col">
          <div class="card h-100 shadow-sm border-0">
            <!-- Product Image or Placeholder -->
            <% if product.image.attached? %>
              <%= image_tag product.image, class: "card-img-top", style: "height: 200px; object-fit: cover;", alt: product.name %>
            <% else %>
              <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                <i class="bi bi-box-seam display-1 text-secondary"></i>
              </div>
            <% end %>

            <!-- Stock Badge -->
            <span class="position-absolute top-0 end-0 m-2 badge bg-<%= product.stock_status_class %>">
              <%= product.stock_status_label %>
            </span>

            <div class="card-body d-flex flex-column">
              <h5 class="card-title fw-bold"><%= product.name %></h5>

              <!-- Category Badge -->
              <% if product.category %>
                <span class="badge bg-info mb-2" style="width: fit-content;"><%= product.category.name %></span>
              <% end %>

              <p class="card-text text-muted flex-grow-1"><%= truncate(product.description, length: 100) %></p>
              <div class="d-flex justify-content-between align-items-center mt-3">
                <span class="h4 mb-0 text-primary"><%= product.formatted_price %></span>
              </div>
            </div>

            <div class="card-footer bg-white border-top-0 pb-3">
              <div class="d-grid gap-2">
                <% if product.in_stock? %>
                  <%= button_to "Add to Cart", cart_items_path(product_id: product.id), method: :post, class: "btn btn-success" %>
                <% else %>
                  <button class="btn btn-secondary" disabled>Out of Stock</button>
                <% end %>
                <div class="btn-group w-100" role="group">
                  <%= link_to "View", product_path(product), class: "btn btn-outline-primary" %>
                  <%= link_to "Edit", edit_product_path(product), class: "btn btn-outline-warning" %>
                  <%= button_to "Delete", product_path(product), method: :delete, data: { turbo_confirm: "Are you sure?" }, class: "btn btn-outline-danger" %>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="text-center py-5">
      <i class="bi bi-inbox display-1 text-muted"></i>
      <p class="lead mt-3">No products match your filters.</p>
      <% if @active_filters_count.to_i > 0 %>
        <%= link_to "Clear Filters", products_path, class: "btn btn-outline-primary me-2" %>
      <% end %>
      <%= link_to "Add Your First Product", new_product_path, class: "btn btn-primary btn-lg mt-2" %>
    </div>
  <% end %>
</div>